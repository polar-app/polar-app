# % >= 2.1 Required for Orbs
version: 2.1

# @ Custom Orbs
orbs:
  win: circleci/windows@2.2.0
  cypress: cypress-io/cypress@1.28.0

# ~ Pre-Script Steps to Execute before Jobs
commands:
  build_setup:
    description: setup the build for commands
    steps:
      - checkout

      # ! Add SSH Keys for publishing
      - add_ssh_keys:
          fingerprints:
            - "26:22:fe:b3:b7:ce:d8:43:cf:2d:e6:17:26:31:d1:58"
            - "37:a5:24:7a:89:73:b1:cf:11:3d:98:de:b4:50:25:58"
            - "16:e3:06:7e:6e:58:07:3a:20:35:14:c3:7e:98:33:bb"
            - "SHA256:uwzneTU1Stml8f1GDcffUJPK6GxSs77+vMZOHopRJLE burton@getpolarized.io"

      # ! Download and cache dependencies
      - restore_cache:
          keys:
            - yarn-packages-v1-{{ .Branch }}-{{ checksum "yarn.lock" }}
            - yarn-packages-v1-{{ .Branch }}-
            - yarn-packages-v1-

      # ! Install Basic Modules { lerna, npm, firebase tools }
      - run:
          name: Install global node_modules
          command: |
            sudo yarn global add lerna@4.0.0
            sudo yarn global add npm@7.19.1
            sudo yarn global add firebase-tools@9.16.0

      # ! Install Required Linux Binary (libvips is needed by sharp which is needed by gatsby)
      - run:
          name: Required Linux packages
          command: if [ "$OSTYPE" = 'linux-gnu' ]; then sudo apt-get update && sudo apt-get install libvips libvips-dev pngquant; fi

      # ? Debug Step for Node/Npm/Yarn/Lerna/Firebase Versions
      - run:
          name: DEBUG(Node, NPM, Yarn, Lerna & Firebase Versions)
          command: |
            echo -n "Node version: "
            node --version
            echo -n "NPM version: "
            npm --version
            echo -n "Yarn version: "
            yarn --version
            echo -n "Lerna version: "
            lerna --version
            echo -n "firebase version: "
            firebase --version

      # ? Debug Step for OS version
      - run:
          name: DEBUG(OS Environment)
          command: |
            echo $OSTYPE
            uname -a

      # ? Debug step for Npm/Yarn Configuration
      - run:
          name: DEBUG(NPM/Yarn Setup)
          command: |
            cp .npmrc ~/.npmrc
            cat ~/.npmrc
            echo "npm ping: ======"
            npm ping
            echo "npm config list: ======"
            npm config list
            echo "npm config ls -l: ======"
            npm config ls -l
            echo "yarn config list: ======"
            yarn config list

      # ! Hoist all Dependencies
      - run:
          name: Lerna Bootstrap
          no_output_timeout: 30m
          command: |
            npm config set legacy-peer-deps true
            npx lerna bootstrap --ci

      # ! Save Cache
      - save_cache:
          paths:
            - ~/.cache/yarn
          key: yarn-packages-v1-{{ .Branch }}-{{ checksum "yarn.lock" }}

      # ! Compile all Typescript Packages
      - run:
          name: Lerna Compile
          command: npx lerna run compile

# ~ Workflow Building Blocks
jobs:
  # @ Run Karma Test Suite
  karma:
    parameters:
      executor:
        type: executor
    executor: << parameters.executor>>
    working_directory: ~/repo
    description: "Run our karma tests in the browser."
    steps:
      - build_setup
      - run:
          name: karma
          command: |
            cd packages/polar-bookshelf
            sudo apt-get install chromium
            export CHROME_BIN='/usr/bin/chromium'
            yarn run webpack
            yarn run karma

  # @ Build Polar-Bookshelf Webapp
  build-webapp:
    parameters:
      executor:
        type: executor
    executor: << parameters.executor>>
    working_directory: ~/repo
    steps:
      - build_setup
      - run:
          name: build and verify webapp
          command: |
            cd packages/polar-bookshelf && \
            free -m && \
            yarn run build-webapp && \
            echo "Webapp Built Successfully" && \
            pwd && \
            cat dist/public/repository-bundle.js | gzip -c > dist/public/repository-bundle.js.gz
            find dist/public/repository-bundle.js.gz -size +1300000c |tee /dev/stderr| egrep '.*'

  # @ Build getpolarized.io Website
  build-site:
    parameters:
      executor:
        type: executor
    executor: << parameters.executor>>
    working_directory: ~/repo
    steps:
      - build_setup
      - run:
          name: build and verify site (getpolarized.io)
          command: |
            pwd
            cd packages/polar-site2
            yarn run dist

  # @ Deploy Polar-Bookshelf
  deploy_app_getpolarized_io:
    parameters:
      executor:
        type: executor
      firebase_hosting_target:
        type: string
    executor: << parameters.executor>>
    working_directory: ~/repo
    steps:
      - build_setup
      - run:
          name: init - setup credentials and bytesafe
          no_output_timeout: 120m
          command: |
            npm config set always-auth true
            source packages/polar-bookshelf-secrets/credentials.sh
            rm -f ~/.npmrc && cat .npmrc > ~/.npmrc
            lerna bootstrap
            lerna run compile
            lerna run test
            yarn run dist-validate-env
            lerna exec --concurrency=1 --parallel=false --no-private  --no-bail -- yarn publish --verbose
            (cd packages/polar-app-private/polar-webapp-dist && yarn run dist)
      - run:
          name: release
          no_output_timeout: 120m
          command: |
            source packages/polar-bookshelf-secrets/credentials.sh
            yarn run set-registry-bytesafe-rw
            export FIREBASE_HOSTING_TARGET=<< parameters.firebase_hosting_target >>
            (cd packages/polar-app-private/polar-hooks/functions && rm -rf node_modules && npm install)
            (cd packages/polar-app-private/polar-hooks/functions && echo Pushing to target ${FIREBASE_HOSTING_TARGET} && firebase use polar-32b0f && firebase target:clear hosting app.getpolarized.io && firebase target:apply hosting app.getpolarized.io ${FIREBASE_HOSTING_TARGET} && firebase deploy --only hosting,storage,firestore)
            (cd packages/polar-app-private/polar-hooks/ && time firebase deploy --only functions)

  # @ Deploy getpolarized.io
  deploy_getpolarized_io:
    parameters:
      executor:
        type: executor
    executor: << parameters.executor>>
    working_directory: ~/repo
    steps:
      - run:
          name: deploy
          command: |
            pwd
            cd packages/polar-site2
            yarn run dist-release

# ~ Define Custom Executors
executors:
  # ! Default Executor for most jobs
  my-docker:
    docker:
      - image: circleci/node:14.16.0-buster
    resource_class: xlarge

# ~ Define Workflow Steps
workflows:
  version: 2
  main:
    jobs:
      - cypress/install:
          executor: cypress/base-14
          post-checkout:
            - run: "rm -f ~/.npmrc && cp ./.npmrc ~/"
            - run: "yarn global add lerna@4.0.0 && yarn global add npm@7.19.1"
          install-command: "lerna bootstrap"
          post-install:
            - run: "lerna run compile"

      - cypress/run:
          executor: cypress/base-14
          requires:
            - cypress/install
          working_directory: packages/polar-bookshelf
          start: npx webpack serve
          wait-on: "http://localhost:8050"
          command: (cd packages/polar-bookshelf && npx cypress run)
          attach-workspace: true

      - karma:
          executor: my-docker

      - build-webapp:
          executor: my-docker

      - build-site:
          executor: my-docker

      - hold_app_getpolarized_io:
          type: approval
          requires:
            - karma
            - build-webapp
          filters:
            branches:
              only:
                - master

      - deploy_app_getpolarized_io:
          executor: my-docker
          firebase_hosting_target: polar-webapp
          requires:
            - hold_app_getpolarized_io
          filters:
            branches:
              only:
                - master

      - hold_getpolarized_io:
          type: approval
          requires:
            - build-site
          filters:
            branches:
              only:
                - master

      - deploy_getpolarized_io:
          executor: my-docker
          requires:
            - hold_getpolarized_io
          filters:
            branches:
              only:
                - master
